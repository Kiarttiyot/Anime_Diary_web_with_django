{% extends 'app_general/components/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_general/dashboard.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

<div class="dashboard">
  <div class="profile-header">
    {% if profile_user.profile and profile_user.profile.profile_image %}
      <img src="{{ profile_user.profile.profile_image.url }}" alt="Profile Picture" class="profile-pic">
    {% else %}
      <img src="{% static 'app_general/default-avatar.png' %}" alt="Profile Picture" class="profile-pic">
    {% endif %}

    <div class="profile-info">
      <h2>Dashboard: {{ profile_user.username }}</h2>

      {% if query %}
        <p class="muted">มาจากการค้นหา: "{{ query }}"</p>
      {% endif %}

      {% if profile_user.profile and profile_user.profile.address %}
        <p>{{ profile_user.profile.address }}</p>
      {% endif %}

      <div class="stats" id="stats">
        <span><b>{{ posts|length }}</b> posts</span>

        <a href="{% url 'follower_list' username=profile_user.username %}" class="link-unstyled" style="text-decoration:none; color:inherit;">
          <span class="ms-3"><b id="followers-count">{{ followers_count }}</b> ผู้ติดตาม</span>
        </a>

        <a href="{% url 'following_list' username=profile_user.username %}" class="link-unstyled" style="text-decoration:none; color:inherit;">
          <span class="ms-3"><b id="following-count">{{ following_count }}</b> กำลังติดตาม</span>
        </a>
      </div>

      {% if request.user.is_authenticated %}
        {% if request.user == profile_user %}
          <!-- ✅ ถ้าเป็นผู้ใช้ตัวเอง ให้แสดงปุ่ม Dashboard เต็ม -->
          <div class="profile-actions">
                <span><a href="{% url 'profile' %}">
                    <button class="btn">Edit profile</button>
                </a></span>
                <span><a href="{% url 'archive_list' %}">
                    <button class="btn">Archive</button>
                </a></span>
                </a>
                <a href="{% url 'create_post' %}" class="btn">
                    <img src="{% static 'app_general/plus.png' %}" alt="สร้างโพสต์" style="width:20px;height:20px;">
                </a>      
        </div>
        {% else %}
          <!-- ✅ ถ้าเป็นผู้อื่น แสดงปุ่มติดตาม -->
          {% csrf_token %}
          <button
            id="follow-btn"
            class="btn btn-sm {% if is_following %}btn-danger{% else %}btn-primary{% endif %}"
            data-url="{% url 'follow_toggle' username=profile_user.username %}">
            {% if is_following %}เลิกติดตาม{% else %}ติดตาม{% endif %}
          </button>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <hr>

  <div class="posts-grid">
    {% for post in posts %}
      <a href="{% url 'post_detail' post.pk %}" class="post-link">
        <div class="post-item">
          {% if post.name %}<h4>{{ post.name }}</h4>{% endif %}
          {% if post.image %}
            <img src="{{ post.image.url }}" alt="Post" style="max-width:300px;">
          {% endif %}
          <div style="padding:10px;"></div>
          {% if post.state %}
            <p>สถานะ: {{ post.state }}</p>
          {% endif %}

          {% if post.score is not None %}
          <div class="rating" aria-label="คะแนน {{ post.score }}/10">
            {% for _ in "12345" %}
              {% with threshold=forloop.counter|add:forloop.counter %}
              {% with half=threshold|add:"-1" %}
                {% if post.score >= threshold %}
                  <i class="fa-solid fa-star"></i>
                {% elif post.score == half %}
                  <i class="fa-solid fa-star-half-stroke"></i>
                {% else %}
                  <i class="fa-regular fa-star"></i>
                {% endif %}
              {% endwith %}{% endwith %}
            {% endfor %}
            <span class="rating-text">{{ post.score }}/10</span>
          </div>
          {% endif %}

          <small>{{ post.created_at|date:"Y-m-d H:i" }}</small>
        </div>
      </a>
    {% empty %}
      <p>ยังไม่มีโพสต์</p>
    {% endfor %}
  </div>

  <div style="margin-top:16px;"></div>
</div>

<!-- ✅ AJAX สำหรับ follow toggle -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const followBtn = document.getElementById("follow-btn");
  const followersCountEl = document.getElementById("followers-count");
  const followingCountEl = document.getElementById("following-count");

  if (!followBtn) return;

  followBtn.addEventListener("click", async () => {
    const url = followBtn.dataset.url;
    const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    try {
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest"
        },
      });

      if (response.ok) {
        const data = await response.json();

        // ✅ เปลี่ยนข้อความปุ่ม
        followBtn.textContent = data.is_following ? "เลิกติดตาม" : "ติดตาม";
        followBtn.className = data.is_following ? "btn btn-sm btn-danger" : "btn btn-sm btn-primary";

        // ✅ อัปเดตจำนวนผู้ติดตาม / กำลังติดตาม
        if (followersCountEl) followersCountEl.textContent = data.followers_count;
        if (followingCountEl) followingCountEl.textContent = data.following_count;
      } else {
        console.error("Follow toggle failed:", response.status);
      }
    } catch (err) {
      console.error("Network error:", err);
    }
  });
});
</script>
<script>
async function toggleLike(postId, event) {
  event.preventDefault();
  const likeIcon = document.querySelector(`#like-icon-${postId}`) || event.target.closest('.like-btn').querySelector('i');
  const countSpan = document.querySelector(`#like-count-${postId}`);
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  try {
    const response = await fetch(`/users/post/${postId}/like/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      },
    });

    if (response.ok) {
      const data = await response.json();
      if (data.liked) {
        likeIcon.classList.remove("fa-regular");
        likeIcon.classList.add("fa-solid");
        likeIcon.style.color = "red";
      } else {
        likeIcon.classList.remove("fa-solid");
        likeIcon.classList.add("fa-regular");
        likeIcon.style.color = "black";
      }
      if (countSpan) countSpan.textContent = data.like_count;
    } else {
      console.error("Error toggling like:", response.status);
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}
</script>
{% endblock %}

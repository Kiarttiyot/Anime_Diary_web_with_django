{% extends 'app_general/components/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_general/dashboard.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

<div class="dashboard">

  <div class="profile-header">
    {% if profile_user.profile and profile_user.profile.profile_image %}
      <img src="{{ profile_user.profile.profile_image.url }}" alt="Profile Picture" class="profile-pic">
    {% else %}
      <img src="{% static 'app_general/default-avatar.png' %}" alt="Profile Picture" class="profile-pic">
    {% endif %}

    <div class="profile-info">
      <h2>Dashboard: {{ profile_user.username }}</h2>

      {% if query %}
        <p class="muted">มาจากการค้นหา: "{{ query }}"</p>
      {% endif %}

      {% if profile_user.profile and profile_user.profile.address %}
        <p>{{ profile_user.profile.address }}</p>
      {% endif %}

      <div class="stats">
                <span><b>{{ posts|length }}</b> posts</span>
        
                <a href="{% url 'follower_list' username=profile_user.username %}" class="link-unstyled" style="text-decoration:none; color:inherit;">
                    <span class="ms-3"><b>{{ followers_count }}</b> ผู้ติดตาม</span>
                </a>
        
                <a href="{% url 'following_list' username=profile_user.username %}" class="link-unstyled" style="text-decoration:none; color:inherit;">
                    <span class="ms-3"><b>{{ following_count }}</b> กำลังติดตาม</span>
                </a>
      </div>
      
      {% if request.user.is_authenticated and request.user != profile_user %}
        <form method="post" action="{% url 'follow_toggle' username=profile_user.username %}" class="ms-auto">
          {% csrf_token %}
          {% if is_following == True %}
            <button type="submit" class="btn btn-sm btn-danger">เลิกติดตาม</button>
          {% else %}
            <button type="submit" class="btn btn-sm btn-primary">ติดตาม</button>
          {% endif %}
        </form>
      {% endif %}

    </div>

    </div>

  {% if request.user == profile_user %}
    <div class="btn-group profile-actions-group">
      <a href="{% url 'create_post' %}" class="btn">
        <img src="{% static 'app_general/plus.png' %}" alt="สร้างโพสต์" style="width:25px;height:25px;vertical-align:middle;">
        <span style="margin-left:6px;">สร้างโพสต์</span>
      </a>
      <a href="{% url 'profile' %}" class="btn">edit profile</a>
      <a href="{% url 'archive_list' %}" class="btn">Archive</a> 
    </div>
  {% endif %}

  <hr>

  <div class="posts-grid">
    {% for post in posts %}
      <a href="{% url 'post_detail' post.pk %}" class="post-link">
        <div class="post-item">
          {% if post.name %}<h4>{{ post.name }}</h4>{% endif %}
          {% if post.image %}<img src="{{ post.image.url }}" alt="Post" style="max-width:300px;">{% endif %}
          <div style="padding:10px;"></div>
          {% if post.state %}<p>สถานะ: {{ post.state }}</p>{% endif %}

          {% if post.score is not None %}
          <div class="rating" aria-label="คะแนน {{ post.score }}/10">
            {% for _ in "12345" %}
              {% with threshold=forloop.counter|add:forloop.counter %}
              {% with half=threshold|add:"-1" %}
                {% if post.score >= threshold %}
                  <i class="fa-solid fa-star"></i>
                {% elif post.score == half %}
                  <i class="fa-solid fa-star-half-stroke"></i>
                {% else %}
                  <i class="fa-regular fa-star"></i>
                {% endif %}
              {% endwith %}{% endwith %}
            {% endfor %}
            <span class="rating-text">{{ post.score }}/10</span>
          </div>
          {% endif %}

          <small>{{ post.created_at|date:"Y-m-d H:i" }}</small>
        </div>
      </a>
    {% empty %}
      <p>ยังไม่มีโพสต์</p>
    {% endfor %}
  </div>

  <div style="margin-top:16px;">
    <a href="{% url 'friend' %}">← กลับไปหน้าค้นหา</a>
  </div>
</div>
{% endblock %}
{% load static %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'app_general/post_detil.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">


<div class="container mt-5">
    
    <div class="post-box">
        <div class="post-header">
            {% if post.name %}
                <h4>{{ post.name }}</h4>
            {% endif %}
            <div class="rating" aria-label="คะแนน {{ post.score }}/10">
                {% for _ in "12345" %}
                    {% with threshold=forloop.counter|add:forloop.counter %}
                    {% with half=threshold|add:"-1" %}
                        {% if post.score >= threshold %}
                            <i class="fa-solid fa-star"></i>
                        {% elif post.score == half %}
                            <i class="fa-solid fa-star-half-stroke"></i>
                        {% else %}
                            <i class="fa-regular fa-star"></i>
                        {% endif %}
                    {% endwith %}
                    {% endwith %}
                {% endfor %}
                <span class="rating-text">{{ post.score }}/10</span>
            </div>
            {% if request.user.is_authenticated and request.user == post.user %}
            <div class="dropdown" style="position: relative; display: inline-block; ">
                <button onclick="toggleDropdown()" class="dropbtn" style="background: none; border: none; cursor: pointer;">
                    <i class="fa-solid fa-ellipsis-vertical" style="font-size: 20px;"></i>
                </button>

                <div id="myDropdown" class="dropdown-content" 
                    style="display: none; position: absolute; right: 0; background-color: #fff; 
                        min-width: 150px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 6px; z-index: 100;">
                    <!-- ปุ่ม Edit -->
                    <a href="{% url 'edit_post' post.pk %}" class="dropdown-item" style="display:block; padding:8px 12px; text-decoration:none; color:#333;">
                        Edit
                    </a>

                    <!-- ปุ่ม Archive -->
                    <form action="{% url 'post_archive' post.pk %}" method="post" style="margin:0;">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item" 
                            style="width:100%; text-align:left; background:none; border:none; padding:8px 12px; cursor:pointer;">
                            Archive
                        </button>
                    </form>

                    <!-- ปุ่ม Delete -->
                    <form action="{% url 'post_delete' post.pk %}" method="post" style="margin:0;"
                        onsubmit="return confirm('แน่ใจหรือไม่ว่าต้องการลบโพสต์นี้?');">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item" 
                            style="width:100%; text-align:left; background:none; border:none; color:red; padding:8px 12px; cursor:pointer;">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="mid">
            {% if post.image %}
            <div class="post-image">
                <img src="{{ post.image.url }}" alt="Post">
            </div>
            {% endif %}
            
            <div class="comments">
                <h4>Reviews:</h4>
                <!-- กรอบคอมเมนต์ -->
                <div class="comments-box" id="commentsBox">
                {% for comment in post.comments.all %}
                    <div class="comment">
                        {% if comment.user.profile.profile_image %}
                            <img src="{{ comment.user.profile.profile_image.url }}" 
                                alt="{{ comment.user.username }}" 
                                class="comment-pic">
                        {% else %}
                            <img src="{% static 'images/default.png' %}" 
                                alt="default profile" 
                                class="comment-pic">
                        {% endif %}
                        <div class="buc">
                            <strong>{{ comment.user.username }}:</strong> 
                            <p>
                                {{ comment.content }}
                            </p>
                        </div>
                    </div>
                {% empty %}
                    <p>No comments yet.</p>
                {% endfor %}
            </div>

            <!-- ฟอร์ม -->
            <form id="commentForm" method="post" action="{% url 'add_comment' post.id %}" class="comment-form">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." required>
                <button type="submit">Comment</button>
            </form>
            </div>            

            
           
        </div>
        {% for post in posts %}
            {{ post.content }}
        {% endfor %}
        {% if post.content %}
            <p class="post-content">{{ post.content }}</p>
        {% endif %}

        {% if post.state %}
            <p class="post-state">สถานะ: {{ post.state }}</p>
        {% endif %}

        <div class="post-meta">
            <span class="like-btn" onclick="toggleLike('{{ post.pk }}', event)">
                {% if post.is_liked %}
                    <i id="like-icon-{{ post.pk }}" class="fa-solid fa-heart" style="color:red;"></i>
                {% else %}
                    <i id="like-icon-{{ post.pk }}" class="fa-regular fa-heart"></i>
                {% endif %}
                <span id="like-count-{{ post.pk }}">{{ post.likes.count }}</span>
            </span>
            <span class="meta-separator"></span>
            <span><i class="fa-regular fa-comment"></i> {{ post.comments.count }}</span>
        </div>
        <!-- {% if request.user.is_authenticated and request.user == post.user %}
            <!-- ปุ่มที่ใช้ได้เฉพาะเจ้าของโพสต์ -
            <div class="www"  style="display: flex; justify-content: flex-end; gap: 10px;">
                <form action="{% url 'post_delete' post.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Delete</button>
                </form>
                
                
                <form action="{% url 'post_archive' post.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Archive</button>
                </form>
            </div>   
        {% endif %} -->
        

        <script>
        function toggleDropdown() {
            const dropdown = document.getElementById("myDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        // ปิด dropdown เมื่อคลิกข้างนอก
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                document.getElementById("myDropdown").style.display = "none";
            }
        }
        </script>
        {% endif %}
    
        
        
    

                
                      
        
        
    </div>
</div>
{% endblock %}
 <!-- <div class="dropdown">
                
                <button onclick="toggleDropdown()" class="dropbtn">Menu</button>
                    {% if request.user == profile_user %}
                        <div id="myDropdown" class="dropdown-content">
                        
                            <form action="{% url 'post_delete' post.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <a type="submit" class="btn btn-danger">Delete</a>
                            </form>
                            <form action="{% url 'post_archive' post.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <a type="submit" class="btn btn-warning">Archive</a>
                            </form>
                    
                         </div>
                    {% endif %}
            </div> -->
<!-- 

                // function toggleDropdown() {
    //     document.getElementById("myDropdown").classList.toggle("show");
    // }

        // ปิด dropdown เมื่อคลิกข้างนอก
// window.onclick = function(event) {
//     if (!event.target.matches('.dropbtn')) {
//         let dropdowns = document.getElementsByClassName("dropdown-content");
//         for (let i = 0; i < dropdowns.length; i++) {
//             if (dropdowns[i].classList.contains('show')) {
//                 dropdowns[i].classList.remove('show');
//             }
//         }
//     }
// } -->

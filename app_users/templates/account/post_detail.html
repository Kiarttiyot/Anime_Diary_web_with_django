{% load static %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'app_general/post_detil.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">


<div class="container mt-5">
    
    <div class="post-box">
        <div class="post-header">
            {% if post.name %}
                <h4>{{ post.name }}</h4>
            {% endif %}
            <div class="rating" aria-label="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô {{ post.score }}/10">
                {% for _ in "12345" %}
                    {% with threshold=forloop.counter|add:forloop.counter %}
                    {% with half=threshold|add:"-1" %}
                        {% if post.score >= threshold %}
                            <i class="fa-solid fa-star"></i>
                        {% elif post.score == half %}
                            <i class="fa-solid fa-star-half-stroke"></i>
                        {% else %}
                            <i class="fa-regular fa-star"></i>
                        {% endif %}
                    {% endwith %}
                    {% endwith %}
                {% endfor %}
                <span class="rating-text">{{ post.score }}/10</span>
            </div>
            {% if request.user.is_authenticated and request.user == post.user %}
            <div class="dropdown" style="position: relative; display: inline-block; ">
                <button onclick="toggleDropdown()" class="dropbtn" style="background: none; border: none; cursor: pointer;">
                    <i class="fa-solid fa-ellipsis-vertical" style="font-size: 20px;"></i>
                </button>

                <div id="myDropdown" class="dropdown-content" 
                    style="display: none; position: absolute; right: 0; background-color: #fff; 
                        min-width: 150px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 6px; z-index: 100;">
                    <!-- ‡∏õ‡∏∏‡πà‡∏° Edit -->
                    <a href="{% url 'edit_post' post.pk %}" class="dropdown-item" style="display:block; padding:8px 12px; text-decoration:none; color:#333;">
                        Edit
                    </a>

                    <!-- ‡∏õ‡∏∏‡πà‡∏° Archive -->
                    <form action="{% url 'post_archive' post.pk %}" method="post" style="margin:0;">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item" 
                            style="width:100%; text-align:left; background:none; border:none; padding:8px 12px; cursor:pointer;">
                            Archive
                        </button>
                    </form>

                    <!-- ‡∏õ‡∏∏‡πà‡∏° Delete -->
                    <form action="{% url 'post_delete' post.pk %}" method="post" style="margin:0;"
                        onsubmit="return confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ?');">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item" 
                            style="width:100%; text-align:left; background:none; border:none; color:red; padding:8px 12px; cursor:pointer;">
                            Delete
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="mid">
            {% if post.image %}
            <div class="post-image">
                <img src="{{ post.image.url }}" alt="Post">
            </div>
            {% endif %}
            
            <div class="comments">
            <h4>Reviews:</h4>

            <div class="comments-box" id="commentsBox">
                {% for comment in post.comments.all %}
                <div class="comment" id="comment-{{ comment.id }}">
                    <img src="{{ comment.user.profile.profile_image.url|default:'/static/app_general/default-avatar.png' }}" 
                        alt="{{ comment.user.username }}" class="comment-pic">
                    <div class="buc">
                    <strong>{{ comment.user.username }}:</strong>
                    <p>{{ comment.content }}</p>
                    </div>
                   
                   <!-- ‚úÖ Dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå -->
                    <div class="comment-dropdown">
                      <button class="comment-dropbtn">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                      </button>
                      <div class="comment-dropdown-content">
                        <button class="delete-comment" data-id="{{ comment.id }}">‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</button>
                      </div>
                    </div>



                </div>
                {% empty %}
                <p>No comments yet.</p>
                {% endfor %}
            </div>
            <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
            <form id="commentForm" class="comment-form" data-post-id="{{ post.id }}">
                {% csrf_token %}
                <input type="text" name="content" placeholder="Add a comment..." required>
                <button type="submit">Comment</button>
            </form>


            </div>            

            
           
        </div>
        {% for post in posts %}
            {{ post.content }}
        {% endfor %}
        {% if post.content %}
            <p class="post-content">{{ post.content }}</p>
        {% endif %}

        {% if post.state %}
            <p class="post-state">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {{ post.state }}</p>
        {% endif %}

        <div class="post-meta">
            <span class="like-btn" onclick="toggleLike('{{ post.id }}', event)">
                {% if post.is_liked %}
                <i id="like-icon-{{ post.id }}" class="fa-solid fa-heart" style="color:red;"></i>
                {% else %}
                <i id="like-icon-{{ post.id }}" class="fa-regular fa-heart"></i>
                {% endif %}
            <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
</span>
            <span class="meta-separator"></span>
            <span><i class="fa-regular fa-comment"></i> {{ post.comments.count }}</span>
        </div>
        <!-- {% if request.user.is_authenticated and request.user == post.user %}
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå -
            <div class="www"  style="display: flex; justify-content: flex-end; gap: 10px;">
                <form action="{% url 'post_delete' post.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Delete</button>
                </form>
                
                
                <form action="{% url 'post_archive' post.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Archive</button>
                </form>
            </div>   
        {% endif %} -->
        
        <script>
          document.addEventListener("click", function(e) {
            // toggle ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏¥‡∏î dropdown
            if (e.target.closest(".comment-dropbtn")) {
              const dropdown = e.target.closest(".comment-dropdown");
              dropdown.classList.toggle("show");
            } else {
              document.querySelectorAll(".comment-dropdown.show").forEach(d => d.classList.remove("show"));
            }
          });
        </script>
        <script>
        function toggleDropdown() {
            const dropdown = document.getElementById("myDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        // ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
        window.onclick = function(event) {
            if (!event.target.closest('.dropdown')) {
                document.getElementById("myDropdown").style.display = "none";
            }
        }
        </script>
    
        
        
    

                
                      
        
        
    </div>
</div>
{% endblock %}
 <!-- <div class="dropdown">
                
                <button onclick="toggleDropdown()" class="dropbtn">Menu</button>
                    {% if request.user == profile_user %}
                        <div id="myDropdown" class="dropdown-content">
                        
                            <form action="{% url 'post_delete' post.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <a type="submit" class="btn btn-danger">Delete</a>
                            </form>
                            <form action="{% url 'post_archive' post.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <a type="submit" class="btn btn-warning">Archive</a>
                            </form>
                    
                         </div>
                    {% endif %}
            </div> -->
<!-- 

                // function toggleDropdown() {
    //     document.getElementById("myDropdown").classList.toggle("show");
    // }

        // ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
// window.onclick = function(event) {
//     if (!event.target.matches('.dropbtn')) {
//         let dropdowns = document.getElementsByClassName("dropdown-content");
//         for (let i = 0; i < dropdowns.length; i++) {
//             if (dropdowns[i].classList.contains('show')) {
//                 dropdowns[i].classList.remove('show');
//             }
//         }
//     }
// } -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("commentForm");
  const commentsBox = document.getElementById("commentsBox");

  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const postId = form.dataset.postId;
    const content = form.querySelector("input[name='content']").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const response = await fetch(`/users/post/${postId}/comment/ajax/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `content=${encodeURIComponent(content)}`
    });

    const data = await response.json();
    if (response.ok) {
      const newComment = document.createElement("div");
      newComment.classList.add("comment");
      newComment.id = `comment-${data.id}`;
      newComment.innerHTML = `
        <img src="${data.profile_image}" class="comment-pic">
        <div class="buc">
          <strong>${data.user}:</strong>
          <p>${data.content}</p>
        </div>
        <button class="delete-comment" data-id="${data.id}">üóëÔ∏è</button>
      `;
      commentsBox.appendChild(newComment);
      form.reset();
    } else {
      alert(data.error || "Error posting comment");
    }
  });

  document.addEventListener("click", async function(e) {
    if (e.target.classList.contains("delete-comment")) {
      const id = e.target.dataset.id;
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      if (!confirm("‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      const response = await fetch(`/users/comment/${id}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken }
      });

      const data = await response.json();
      if (response.ok) {
        const commentElement = document.getElementById(`comment-${id}`);
        commentElement.classList.add("fade-out");
        setTimeout(() => commentElement.remove(), 400);
      } else {
        alert(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }
  });
});

</script>
<script>
async function toggleLike(postId, event) {
  event.preventDefault();
  const likeIcon = document.querySelector(`#like-icon-${postId}`) || event.target.closest('.like-btn').querySelector('i');
  const countSpan = document.querySelector(`#like-count-${postId}`);
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  try {
    const response = await fetch(`/users/post/${postId}/like/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      },
    });

    if (response.ok) {
      const data = await response.json();
      if (data.liked) {
        likeIcon.classList.remove("fa-regular");
        likeIcon.classList.add("fa-solid");
        likeIcon.style.color = "red";
      } else {
        likeIcon.classList.remove("fa-solid");
        likeIcon.classList.add("fa-regular");
        likeIcon.style.color = "black";
      }
      if (countSpan) countSpan.textContent = data.like_count;
    } else {
      console.error("Error toggling like:", response.status);
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}
</script>
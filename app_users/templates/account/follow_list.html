{% extends 'app_general/components/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_general/follow.css' %}">

<div class="container"></div>

<div class="follow-list-container">

  {% if user_list %}
    {% csrf_token %}
    <ul class="follow-list">
      {% for item in user_list %}
        <li class="follow-item">
          <div class="follow-user">
            {% if item.user.profile and item.user.profile.profile_image %}
              <img src="{{ item.user.profile.profile_image.url }}" alt="{{ item.user.username }}" class="profile-pic">
            {% else %}
              <img src="{% static 'app_general/default-avatar.png' %}" alt="avatar" class="profile-pic">
            {% endif %}

            <div>
              <a href="{% url 'user_dashboard_from_search' username=item.user.username %}?q={{ item.user.username }}"
                 class="username-link">
                {{ item.user.username }}
              </a>
            </div>
          </div>

          {% if request.user.is_authenticated and request.user != item.user %}
            {% if profile_user == request.user and list_type == "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°" %}
              <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° -->
              <button class="btn btn-sm btn-outline-danger"
                      data-remove-url="{% url 'remove_follower' item.user.username %}"
                      onclick="removeFollower(this)">
                Remove
              </button>
            {% else %}
              <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° / ‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° -->
              <button
                class="btn btn-sm {% if item.is_following %}btn-danger{% else %}btn-primary{% endif %}"
                data-url="{% url 'follow_toggle' username=item.user.username %}"
                onclick="toggleFollow(this)">
                {% if item.is_following %}Unfollow{% else %}Follow{% endif %}
              </button>
            {% endif %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="no-follow">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
  {% endif %}
</div>

<script>
if (window.removeFollower) {
  window.removeFollower = null; // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
}
/* ‚úÖ Toggle Follow / Unfollow */
async function toggleFollow(button) {
  const url = button.dataset.url;
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      },
    });

    if (response.ok) {
      const data = await response.json();
      button.textContent = data.is_following ? "Unfollow" : "Follow";
      button.className = data.is_following ? "btn btn-sm btn-danger" : "btn btn-sm btn-primary";
    } else {
      console.error("Follow toggle failed:", response.status);
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}


/* üî• Remove Follower (‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤) */
window.removeFollower = async function(button) {
  const url = button.dataset.removeUrl;
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;
  const confirmRemove = confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
  if (!confirmRemove) return;

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      },
    });
    const data = await response.json();

    if (data.removed) {
      // ‚úÖ ‡∏•‡∏ö element ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      button.closest("li").remove();
    } else {
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°");
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}

</script>
{% endblock %}

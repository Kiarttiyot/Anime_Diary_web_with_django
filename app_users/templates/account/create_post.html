{% extends 'app_general/components/base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'app_general/create_post.css' %}">
<!-- Font Awesome (icons) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

<div class="container mt-5">
     <div class="box">
        <h2 class="mb-4 text-center">โพสต์ใหม่</h2>

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Error messages -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
           <!-- Image -->
            <div class="mb-3">
                <!-- wrapper ของ input + preview -->
                <div class="image-upload-wrapper" 
                    style="position: relative; width: 100%; max-width: 300px; height: 200px; border: 2px dashed #ccc; border-radius: 8px; display: flex; justify-content: center; align-items: center; overflow: hidden; cursor: pointer; background-color:#f8f8f8;">
                    {{ form.image }}
                    <img id="preview-image" src="#" alt="Preview" 
                        style="display:none; width: 100%; height: 100%; object-fit: cover;">
                    <div id="placeholder-text" 
                        style="position:absolute; color:#888; font-size:14px; pointer-events:none; text-align:center;">
                        คลิกเพื่อเลือกภาพ
                    </div>
                </div>
            </div>
            <script>
            const imageInput = document.getElementById("id_image");
            const preview = document.getElementById("preview-image");
            const placeholderText = document.getElementById("placeholder-text");
            // ซ่อน input แต่ให้คลิกได้ทั้งกรอบ
            imageInput.style.opacity = 0;
            imageInput.style.width = "100%";
            imageInput.style.height = "100%";
            imageInput.style.position = "absolute";
            imageInput.style.top = 0;
            imageInput.style.left = 0;
            imageInput.style.cursor = "pointer";
            imageInput.addEventListener("change", function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = "block";
                        placeholderText.style.display = "none";
                    }
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = "none";
                    placeholderText.style.display = "block";
                }
            });
            </script>
            <!--<div class="spaceeiei" style="padding: 10px;"></div>-->
            <!-- Post name -->
            <div class="mb-3">
                {{ form.name }}
            </div>
            <!-- Content -->
            <div class="mb-3">
                {{ form.content }}
            </div>
            <!-- State -->
            <div class="mb-3">
                <label class="form-label">สถานะ</label>
                {{ form.state }}
            </div>

            <!-- Score -->
            <div class="mb-3">
            <label class="form-label">ให้คะแนน</label>

            <!-- แถวแสดงดาว -->
            <div id="star-rating" class="d-flex gap-1" style="cursor: pointer; font-size: 2rem; color: gold;">
                <i class="fa-regular fa-star star" data-value="2"></i>
                <i class="fa-regular fa-star star" data-value="4"></i>
                <i class="fa-regular fa-star star" data-value="6"></i>
                <i class="fa-regular fa-star star" data-value="8"></i>
                <i class="fa-regular fa-star star" data-value="10"></i>
            </div>

            <!-- Hidden input ไว้เก็บค่า -->
            {{ form.score }}
            </div>

            <script>
                const stars = document.querySelectorAll("#star-rating .star");
                const scoreInput = document.getElementById("id_score");

                stars.forEach((star, index) => {
                star.addEventListener("mousemove", (e) => {
                    // หาครึ่งซ้าย/ขวา
                    const rect = star.getBoundingClientRect();
                    const isLeft = e.clientX - rect.left < rect.width / 2;
                    const value = isLeft ? (index * 2 + 1) : (index * 2 + 2);

                    highlightStars(value);
                });

                star.addEventListener("click", (e) => {
                    const rect = star.getBoundingClientRect();
                    const isLeft = e.clientX - rect.left < rect.width / 2;
                    const value = isLeft ? (index * 2 + 1) : (index * 2 + 2);

                    scoreInput.value = value; // เก็บค่า 1–10
                });
                });

                // ฟังก์ชันเปลี่ยน UI ดาว
                function highlightStars(value) {
                stars.forEach((s, i) => {
                    const starValue = (i + 1) * 2;
                    s.classList.remove("fa-solid", "fa-star-half-stroke", "fa-regular", "fa-star");

                    if (value >= starValue) {
                    s.classList.add("fa-solid", "fa-star"); // เต็ม
                    } else if (value === starValue - 1) {
                    s.classList.add("fa-solid", "fa-star-half-stroke"); // ครึ่ง
                    } else {
                    s.classList.add("fa-regular", "fa-star"); // ว่าง
                    }
                });
                }
                </script>



            <!--<div class="spaceeiei" style="padding: 10px;"></div>-->
            <!-- Buttons -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'my_dashboard' %}" class="btn btn-secondary">ยกเลิก</a>
                <button type="submit" class="btn btn-primary">โพสต์เลย</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% extends 'app_general/components/base.html' %}
{% load static %}

{% block content %}
{% csrf_token %}

<!-- CSS & Font Awesome -->
<link rel="stylesheet" href="{% static 'app_general/dashboard.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

<div class="dashboard">

    <!-- Profile Header -->
    <div class="profile-header">
        {% if profile_user.profile.profile_image %}
            <img src="{{ profile_user.profile.profile_image.url }}" alt="Profile Picture" class="profile-pic">
        {% else %}
            <img src="{% static 'app_general/default-avatar.png' %}" alt="Profile Picture" class="profile-pic">
        {% endif %}

        <div class="profile-info">
            <h2>{{ profile_user.username }}</h2>
            {% if profile_user.profile.address %}
                <p>{{ profile_user.profile.address }}</p>
            {% endif %}
            <div class="stats">
                <span><b>{{ posts|length }}</b> posts</span>
                <a href="{% url 'follower_list' username=profile_user.username %}" style="text-decoration:none; color:inherit;">
                    <span class="ms-3"><b>{{ followers_count }}</b> ‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span>
                </a>
                <a href="{% url 'following_list' username=profile_user.username %}" style="text-decoration:none; color:inherit;">
                    <span class="ms-3"><b>{{ following_count }}</b> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span>
                </a>
            </div>
        </div>

        {% if request.user == profile_user %}
        <div class="profile-actions">
            <a href="{% url 'profile' %}" class="btn">Edit profile</a>
            <a href="{% url 'archive_list' %}" class="btn">Archive</a>
            <a href="{% url 'create_post' %}" class="btn">
                <img src="{% static 'app_general/plus.png' %}" alt="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå" style="width:20px;height:20px;">
            </a>
        </div>
        {% endif %}
    </div>

    <hr>

    <!-- Posts Grid -->
    <div class="posts-grid">
        {% for post in posts %}
        <div class="post-item" onclick="openPostPopup('{{ post.pk }}')">

            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Post" style="max-width:300px;">
            {% endif %}
            
            <div style="padding: 5px;"></div>
            <div class="post-tex">
                <div class="post-meta">
                    <span class="like-btn" onclick="toggleLike('{{ post.id }}', event)">
                        {% if post.is_liked %}
                            <i id="like-icon-{{ post.id }}" class="fa-solid fa-heart" style="color:red;"></i>
                        {% else %}
                            <i id="like-icon-{{ post.id }}" class="fa-regular fa-heart"></i>
                        {% endif %}
                        <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
                    </span>
                    <span style="padding: 10px;"></span>
                    <span><i class="fa-regular fa-comment"></i> {{ post.comments.count }}</span>
                </div>

                {% if post.state %}
                    <div class="post-state">
                        <p>{{ post.state }}</p>
                    </div>
                {% endif %}

                <div class="rating" aria-label="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô {{ post.score }}/10">
                    {% for _ in "12345" %}
                        {% with threshold=forloop.counter|add:forloop.counter %}
                        {% with half=threshold|add:"-1" %}
                            {% if post.score >= threshold %}
                                <i class="fa-solid fa-star" style="color: gold;"></i>
                            {% elif post.score == half %}
                                <i class="fa-solid fa-star-half-stroke" style="color: gold;"></i>
                            {% else %}
                                <i class="fa-regular fa-star" style="color: gray;"></i>
                            {% endif %}
                        {% endwith %}
                        {% endwith %}
                    {% endfor %}
                    <span class="rating-text">{{ post.score }}/10</span>
                </div>
                <small>{{ post.created_at|date:"Y-m-d H:i" }}</small>
            </div>
        </div>  
        {% empty %}
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</p>
        {% endfor %}
    </div>

    <!-- ‚úÖ Popup Overlay -->
    <div class="modal" id="postPopup" onclick="backgroundClose(event)">
      <div class="modal-content">
        <span class="close-btn" onclick="closePostPopup()">&times;</span>
        <div id="postPopupBody"><!-- HTML ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà --></div>
      </div>
    </div>

</div> <!-- /dashboard -->

<!-- ===================== Scripts ===================== -->
<script>
/* ======================= ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Popup ======================= */
function openPostPopup(postId) {
  fetch(`/users/post/${postId}/`)
    .then(response => response.text())
    .then(html => {
      const popupBody = document.getElementById('postPopupBody');
      popupBody.innerHTML = html;

      // ‚úÖ Attach Event ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô popup ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      attachCommentHandlers(popupBody);
      attachLikeHandlers(popupBody);

      // ‚úÖ ‡πÉ‡∏´‡πâ script ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô popup (‡∏à‡∏≤‡∏Å Django template) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      popupBody.querySelectorAll("script").forEach(oldScript => {
        const newScript = document.createElement("script");
        newScript.text = oldScript.text;
        document.body.appendChild(newScript);
        document.body.removeChild(newScript);
      });

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á popup
      const popup = document.getElementById('postPopup');
      popup.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    })
    .catch(err => console.error("Popup load error:", err));
}

function closePostPopup() {
  document.getElementById('postPopup').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function backgroundClose(event) {
  const modal = document.getElementById('postPopup');
  const content = document.querySelector('.modal-content');
  if (!content.contains(event.target)) {
    closePostPopup();
  }
}

/* ======================= ‚ù§Ô∏è Toggle Like (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å) ======================= */
async function toggleLike(postId, event) {
  event.stopPropagation(); // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏ã‡πâ‡∏≠‡∏ô
  const likeIcon = document.querySelector(`#like-icon-${postId}`);
  const countSpan = document.querySelector(`#like-count-${postId}`);
  const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  try {
    const response = await fetch(`/users/post/${postId}/like/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "X-Requested-With": "XMLHttpRequest"
      },
    });

    if (response.ok) {
      const data = await response.json();
      if (data.liked) {
        likeIcon.classList.remove("fa-regular");
        likeIcon.classList.add("fa-solid", "heart-pop");
        likeIcon.style.color = "red";
        setTimeout(() => likeIcon.classList.remove("heart-pop"), 300);
      } else {
        likeIcon.classList.remove("fa-solid");
        likeIcon.classList.add("fa-regular");
        likeIcon.style.color = "black";
      }
      if (countSpan) countSpan.textContent = data.like_count;
    }
  } catch (err) {
    console.error("Network error:", err);
  }
}

/* ======================= üí¨ Comment Handler (‡πÉ‡∏ô popup) ======================= */
function attachCommentHandlers(popupBody) {
  const form = popupBody.querySelector("#commentForm");
  const commentsBox = popupBody.querySelector("#commentsBox");

  if (!form || !commentsBox) return;

  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå
  form.addEventListener("submit", async function(e) {
    e.preventDefault();
    const postId = form.dataset.postId;
    const content = form.querySelector("input[name='content']").value.trim();
    const csrfToken = popupBody.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!content) return;

    const response = await fetch(`/users/post/${postId}/comment/ajax/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `content=${encodeURIComponent(content)}`
    });

    const data = await response.json();
    if (response.ok) {
      const newComment = document.createElement("div");
      newComment.classList.add("comment");
      newComment.id = `comment-${data.id}`;
      newComment.innerHTML = `
        <img src="${data.profile_image}" class="comment-pic">
        <div class="buc">
          <strong>${data.user}:</strong>
          <p>${data.content}</p>
        </div>
        <button class="delete-comment" data-id="${data.id}">üóëÔ∏è</button>
      `;
      commentsBox.appendChild(newComment);
      form.reset();
    } else {
      alert(data.error || "Error posting comment");
    }
  });

  // ‚úÖ ‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏ô popup
  commentsBox.addEventListener("click", async function(e) {
    if (e.target.classList.contains("delete-comment")) {
      const id = e.target.dataset.id;
      const csrfToken = popupBody.querySelector('[name=csrfmiddlewaretoken]').value;
      if (!confirm("‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

      const response = await fetch(`/users/comment/${id}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken }
      });
      const data = await response.json();
      if (response.ok) {
        const commentEl = document.getElementById(`comment-${id}`);
        commentEl.classList.add("fade-out");
        setTimeout(() => commentEl.remove(), 400);
      } else {
        alert(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }
  });
}

/* ======================= ‚ù§Ô∏è Like Handler (‡πÉ‡∏ô popup) ======================= */
function attachLikeHandlers(popupBody) {
  popupBody.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", async function (e) {
      e.preventDefault();
      e.stopPropagation();

      const postId = this.dataset.postId || this.getAttribute("data-post-id");
      const likeIcon = this.querySelector("i");
      const countSpan = this.querySelector(".like-count");
      const csrfToken = popupBody.querySelector("[name=csrfmiddlewaretoken]").value;

      try {
        const response = await fetch(`/users/post/${postId}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest"
          },
        });
        if (response.ok) {
          const data = await response.json();
          if (data.liked) {
            likeIcon.classList.remove("fa-regular");
            likeIcon.classList.add("fa-solid", "heart-pop");
            likeIcon.style.color = "red";
            setTimeout(() => likeIcon.classList.remove("heart-pop"), 300);
          } else {
            likeIcon.classList.remove("fa-solid");
            likeIcon.classList.add("fa-regular");
            likeIcon.style.color = "black";
          }
          if (countSpan) countSpan.textContent = data.like_count;
        }
      } catch (err) {
        console.error("Like toggle error:", err);
      }
    });
  });
}
</script>


<!-- ===================== CSS ===================== -->
<style>
.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  width: 70%;
  max-width: 900px;
  max-height: 85vh;
  overflow-y: auto;
  padding: 25px;
  position: relative;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  animation: popupShow 0.25s ease;
}

.close-btn {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 26px;
  cursor: pointer;
  color: #333;
}

@keyframes popupShow {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏ö‡∏≤‡πÜ */
@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.4); }
  100% { transform: scale(1); }
}
.heart-pop {
  animation: pop 0.3s ease;
}

/* ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏´‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏•‡∏ö */
.fade-out {
  opacity: 0;
  transition: opacity 0.4s ease;
}
</style>

<div class="space" style="height: 300px;"></div>
{% endblock %}
